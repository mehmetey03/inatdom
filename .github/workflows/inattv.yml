name: Domain Check and Update

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update-domain:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - run: pip install requests

      - name: Prepare domain
        run: |
          if [ -f domain.txt ]; then
            CURRENT_DOMAIN=$(cut -d'=' -f2 domain.txt)
          else
            CURRENT_DOMAIN="https://inattv1217.xyz/"
            echo "guncel_domain=$CURRENT_DOMAIN" > domain.txt
          fi

          echo "CURRENT_DOMAIN=$CURRENT_DOMAIN" >> $GITHUB_ENV

          if echo "$CURRENT_DOMAIN" | grep -q 'inattv[0-9]\+'; then
            DOMAIN_NUMBER=$(echo "$CURRENT_DOMAIN" | grep -o 'inattv[0-9]\+' | grep -o '[0-9]\+')
          else
            DOMAIN_NUMBER="1217"
          fi

          echo "DOMAIN_NUMBER=$DOMAIN_NUMBER" >> $GITHUB_ENV

      - name: Check domain
        run: |
          python3 << 'EOF'
import requests, re, os

headers = {"User-Agent": "Mozilla/5.0"}

current = os.environ["CURRENT_DOMAIN"]
start = int(os.environ["DOMAIN_NUMBER"])

def ok(url):
    try:
        r = requests.get(url, timeout=8, headers=headers)
        return r.status_code == 200 and "tv" in r.text.lower()
    except:
        return False

working = current if ok(current) else None

if not working:
    for i in range(15):
        d = f"https://inattv{start+i}.xyz/"
        if ok(d):
            working = d
            break

if not working:
    working = "https://inattv1217.xyz/"

with open("domain.txt", "w") as f:
    f.write(f"guncel_domain={working}")

print("GÃ¼ncel:", working)
EOF

      - name: Commit
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add domain.txt
          git diff --staged --quiet || git commit -m "Domain update" && git push

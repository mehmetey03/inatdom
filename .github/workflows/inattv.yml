name: Domain inattv 
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update-domain:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests beautifulsoup4

    - name: Smart Domain Check and Update
      run: |
        # Mevcut domaini al veya varsayÄ±lanÄ± kullan
        if [ -f "domain.txt" ]; then
          CURRENT_DOMAIN=$(grep -o 'guncel_domain=.*' domain.txt | cut -d'=' -f2)
          echo "Mevcut domain: $CURRENT_DOMAIN"
        else
          CURRENT_DOMAIN="https://inattv1217.xyz/"
          echo "Yeni domain.txt oluÅŸturuluyor: $CURRENT_DOMAIN"
          echo "guncel_domain=$CURRENT_DOMAIN" > domain.txt
        fi

        # Domain numarasÄ±nÄ± al (numara yoksa 1217 baÅŸlangÄ±Ã§ deÄŸeri kullan)
        if echo "$CURRENT_DOMAIN" | grep -q 'inattv[0-9]\+'; then
          DOMAIN_NUMBER=$(echo $CURRENT_DOMAIN | grep -o 'inattv[0-9]\+' | grep -o '[0-9]\+')
          echo "Bulunan domain numarasÄ±: $DOMAIN_NUMBER"
        else
          DOMAIN_NUMBER="1217"
          echo "VarsayÄ±lan domain numarasÄ±: $DOMAIN_NUMBER"
        fi

        # AkÄ±llÄ± domain kontrolÃ¼ iÃ§in Python scripti
        python3 << 'EOF'
        import requests
        import re
        import sys
        from urllib3.exceptions import InsecureRequestWarning
        
        # SSL uyarÄ±larÄ±nÄ± bastÄ±r
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        
        # GerÃ§ekÃ§i bir User-Agent baÅŸlÄ±ÄŸÄ± tanÄ±mla
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7',
            'Accept-Encoding': 'gzip, deflate',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
            'Cache-Control': 'max-age=0'
        }
        
        def check_domain(domain):
            try:
                print(f"Kontrol ediliyor: {domain}")
                # Ä°steÄŸi User-Agent baÅŸlÄ±ÄŸÄ± ile gÃ¶nder, SSL doÄŸrulamasÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak
                response = requests.get(
                    domain, 
                    timeout=5, 
                    allow_redirects=True, 
                    headers=headers,
                    verify=False
                )
                print(f'  Status Code: {response.status_code}')
                
                # 200 status code kontrolÃ¼
                if response.status_code == 200:
                    # Sayfa iÃ§eriÄŸinde belirli kelimeleri kontrol et (case-insensitive)
                    content = response.text.lower()
                    
                    # SayfanÄ±n boÅŸ olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                    if len(content.strip()) < 100:
                        print(f"  UyarÄ±: Sayfa iÃ§eriÄŸi Ã§ok kÄ±sa ({len(content)} karakter)")
                        return False
                    
                    # Ä°nat TV iÃ§in gerekli anahtar kelimeler
                    if any(keyword in content for keyword in ['channel', 'matches', 'live', 'tv', 'spor', 'yayÄ±n']):
                        # Ek olarak "channel.html" linki var mÄ± kontrol et
                        if 'channel.html' in content:
                            print(f"  âœ… Domain Ã§alÄ±ÅŸÄ±yor ve geÃ§erli iÃ§erik var")
                            return True
                        elif 'inattv' in domain:
                            print(f"  âœ… Domain Ã§alÄ±ÅŸÄ±yor (inattv domaini)")
                            return True
                    
                    print(f"  âŒ GeÃ§erli iÃ§erik bulunamadÄ±")
                    return False
                
                print(f"  âŒ Status code {response.status_code}")
                return False
                
            except requests.exceptions.Timeout:
                print(f"  âŒ Timeout hatasÄ±")
                return False
            except requests.exceptions.ConnectionError:
                print(f"  âŒ BaÄŸlantÄ± hatasÄ±")
                return False
            except requests.exceptions.RequestException as e:
                print(f"  âŒ Ä°stek hatasÄ±: {e}")
                return False
            except Exception as e:
                print(f"  âŒ Beklenmeyen hata: {e}")
                return False
        
        # BaÅŸlangÄ±Ã§ domain numarasÄ±nÄ± al
        start_domain_number = int("$DOMAIN_NUMBER")
        current_domain = "$CURRENT_DOMAIN"
        
        print(f"BaÅŸlangÄ±Ã§ domain numarasÄ±: {start_domain_number}")
        print(f"Mevcut domain: {current_domain}")
        
        # Ã–nce mevcut domaini kontrol et
        latest_working_domain = None
        
        print(f"\n1. Mevcut domain kontrol ediliyor...")
        if check_domain(current_domain):
            latest_working_domain = current_domain
            print(f"âœ“ Mevcut domain Ã§alÄ±ÅŸÄ±yor: {current_domain}")
        else:
            print(f"âœ— Mevcut domain Ã§alÄ±ÅŸmÄ±yor: {current_domain}")
        
        # Yeni domainleri kontrol et
        max_check = 20  # Kontrol edilecek maksimum domain sayÄ±sÄ±
        found_new = False
        
        print(f"\n2. Yeni domainler kontrol ediliyor ({max_check} domain)...")
        for i in range(max_check):
            current_num = start_domain_number + i
            test_domain = f'https://inattv{current_num}.xyz/'
            
            # Mevcut domaini zaten kontrol ettik, tekrar etme
            if test_domain == current_domain:
                continue
                
            print(f"\nDomain {current_num}:")
            if check_domain(test_domain):
                if not found_new:
                    print(f"  ğŸ¯ Yeni aktif domain bulundu: {test_domain}")
                    found_new = True
                latest_working_domain = test_domain
                start_domain_number = current_num  # Bulunan domainden devam et
        
        # Ãœst domainleri kontrol et
        if latest_working_domain:
            print(f"\n3. Ãœst domainler kontrol ediliyor...")
            match = re.search(r'inattv(\d+)', latest_working_domain)
            if match:
                latest_domain_number = int(match.group(1))
                selected_domain = latest_working_domain
                
                # 5 domain daha Ã¼stÃ¼nÃ¼ kontrol et
                for extra in range(1, 6):
                    next_domain = f'https://inattv{latest_domain_number + extra}.xyz/'
                    print(f"\n{extra}. Ã¼st domain ({latest_domain_number + extra}):")
                    
                    if check_domain(next_domain):
                        selected_domain = next_domain
                        print(f"  ğŸ”¼ Ãœst domain aktif, gÃ¼ncelleniyor: {selected_domain}")
                    else:
                        print(f"  âœ– Ãœst domain Ã§alÄ±ÅŸmÄ±yor")
                        break
                
                print(f"\nğŸ¯ SeÃ§ilen domain: {selected_domain}")
            else:
                selected_domain = latest_working_domain
        else:
            # HiÃ§ Ã§alÄ±ÅŸan domain bulunamadÄ±, varsayÄ±lanÄ± kullan
            selected_domain = 'https://inattv1217.xyz/'
            print(f"\nâš  HiÃ§ Ã§alÄ±ÅŸan domain bulunamadÄ±, varsayÄ±lan kullanÄ±lacak: {selected_domain}")
        
        # domain.txt'yi gÃ¼ncelle
        with open('domain.txt', 'w') as f:
            f.write(f'guncel_domain={selected_domain}')
        
        print(f"\nâœ… GÃ¼ncellenen domain: {selected_domain}")
        
        # Mevcut domain ile yeni domain aynÄ± mÄ± kontrol et
        if selected_domain == current_domain:
            print(f"\nâ„¹ Domain deÄŸiÅŸmedi")
        else:
            print(f"\nğŸ”„ Domain deÄŸiÅŸti: {current_domain} -> {selected_domain}")
        EOF

    - name: Commit and push changes
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        
        # DeÄŸiÅŸiklikleri ekle
        git add domain.txt
        
        # DeÄŸiÅŸiklik varsa commit et
        if ! git diff --staged --quiet; then
          git commit -m "GÃ¼ncel domain: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… DeÄŸiÅŸiklikler push edildi"
        else
          echo "â„¹ DeÄŸiÅŸiklik yok, commit atlanÄ±yor"
        fi
